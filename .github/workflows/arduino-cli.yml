name: C/C++ CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build ${{ matrix.board.family }} / ${{ matrix.board.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        board:
          - name: "Seeeduino XIAO"
            fname: "xiao_samd21"
            fqbn: "Seeeduino:samd:seeed_XIAO_m0"
            family: "Seeed SAMD Boards"
            core: "Seeeduino:samd@1.8.5"
            urls: "https://files.seeedstudio.com/arduino/package_seeeduino_boards_index.json"
            extra_libs: ""
            options: ""
          - name: "Rapberry Pi Pico"
            fname: "pico_rp2040"
            fqbn: "rp2040:rp2040:rpipico"
            family: "Raspberry Pi Pico/RP2040/RP2350"
            core: "rp2040:rp2040"
            urls: "https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json"
            extra_libs: "'MIDI Library@5.0.2'"
            options: "usbstack=tinyusb"
          - name: "Rapberry Pi Pico 2"
            fname: "pico2_rp2350"
            fqbn: "rp2040:rp2040:rpipico2"
            family: "Raspberry Pi Pico/RP2040/RP2350"
            core: "rp2040:rp2040"
            urls: "https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json"
            extra_libs: "'MIDI Library@5.0.2'"
            options: ""
          - name: "Pimoroni PicoPlus2"
            fname: "pimoroni_pico_plus2"
            fqbn: "rp2040:rp2040:pimoroni_pico_plus_2"
            family: "Raspberry Pi Pico/RP2040/RP2350"
            core: "rp2040:rp2040"
            urls: "https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json"
            extra_libs: "'MIDI Library@5.0.2'"
            options: ""
        exclude:
          - board:
              name: "Rapberry Pi Pico 2"
          - board:
              name: "Rapberry Pi Pico 2"
          - board:
              name: "Pimoroni PicoPlus2"
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Arduino CLI
      uses: arduino/setup-arduino-cli@v1

    - name: Install core
      run: |
        arduino-cli core update-index --additional-urls ${{ matrix.board.urls }}
        arduino-cli core install ${{ matrix.board.core }} --additional-urls ${{ matrix.board.urls }}

    - name: Install libraries
      run: |
        arduino-cli lib install "Adafruit GFX Library@1.10.10"
        arduino-cli lib install "Adafruit SSD1306@2.4.5"
        arduino-cli lib install "Adafruit BusIO@1.14.1"

        # Install board-specific libs from the matrix
        if [ ! -z "${{ matrix.board.extra_libs }}" ]; then
          arduino-cli lib install ${{ matrix.board.extra_libs }}
        fi

    - name: Install Custom Libraries
      run: |
        mkdir -p ~/Arduino/libraries
        git clone --depth 1 https://github.com/marcel-licence/ML_SynthTools.git ~/Arduino/libraries/ML_SynthTools
        git clone --depth 1 https://github.com/marcel-licence/ML_SynthTools_Lib.git ~/Arduino/libraries/ML_SynthTools_Lib

    - name: Compile sketch
      run: |
        # Combine FQBN and options if options exist
        FULL_FQBN="${{ matrix.board.fqbn }}"
        if [ ! -z "${{ matrix.board.options }}" ]; then
          FULL_FQBN="${FULL_FQBN}:${{ matrix.board.options }}"
        fi
        
        arduino-cli compile \
          --fqbn "$FULL_FQBN" \
          --output-dir build \
          ./

    - name: Generate UF2 (SAMD21)
      if: matrix.board.family == 'SAMD21'
      run: |
        BIN_FILE=$(find build -name "*.bin" | head -n 1)
        curl -L https://raw.githubusercontent.com/microsoft/uf2/master/utils/uf2conv.py -o uf2conv.py
        curl -L https://raw.githubusercontent.com/microsoft/uf2/master/utils/uf2families.json -o uf2families.json
        python3 uf2conv.py "$BIN_FILE" --family ${{ matrix.board.family }} --convert --output build/firmware.uf2

    - name: Rename UF2 (RP2040/RP2350)
      if: matrix.board.family != 'SAMD21'
      run: |
        # The Earle Philhower core usually creates the .uf2 automatically in the output dir
        # We just rename it to a consistent name for the uploader
        mv build/*.uf2 build/firmware.uf2 || true

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.board.fname }}
        path: build/*

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: build/firmware.uf2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}